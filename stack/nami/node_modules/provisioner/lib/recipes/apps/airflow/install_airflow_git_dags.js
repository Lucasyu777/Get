/// <reference path="../../../../typings-recipe.d.ts" />
"use strict";
/*
 * Clone a DAGs project and configure cron
 */
recipes.register({
    id: "clone-git-airflow-project",
    on: { afterInitialize: {} },
    conditions: {
        tierModules: { any: ["airflow", "airflow-scheduler", "airflow-worker"] },
    },
    recipeHandler: async function (input) {
        const systemUsername = "bitnami";
        const appUsername = "airflow";
        const repo = provisioner.appRepository;
        if (repo) {
            const dagsFolder = "/opt/bitnami/airflow/dags";
            logger.info(`Cloning ${repo} into ${dagsFolder}`);
            fs.mkdirSync(dagsFolder, { recursive: true });
            runProgram("chown", [`${systemUsername}:${appUsername}`, dagsFolder]);
            runProgram("/opt/bitnami/git/bin/git", ["clone", repo, dagsFolder], { runAs: systemUsername });
            const cronLine = `* * * * * ${systemUsername} cd ${repo} && /opt/bitnami/git/bin/git pull`;
            const cronFile = "/etc/cron.d/airflow_dags_update";
            fs.writeFileSync(cronFile, `${cronLine}\n`);
        }
        else {
            logger.info("Skipping clone. No DAGs repository provided.");
        }
    }
});
